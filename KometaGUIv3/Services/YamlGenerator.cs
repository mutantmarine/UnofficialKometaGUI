using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using KometaGUIv3.Models;
using YamlDotNet.Serialization;

namespace KometaGUIv3.Services
{
    public class YamlGenerator
    {
        public string GenerateKometaConfig(KometaProfile profile)
        {
            var sb = new StringBuilder();
            
            // YAML header
            sb.AppendLine("# yaml-language-server: $schema=https://raw.githubusercontent.com/kometa-team/kometa/nightly/json-schema/config-schema.json");
            sb.AppendLine("## Generated by Kometa GUI v3");
            sb.AppendLine();

            // Plex configuration
            sb.AppendLine("plex:");
            sb.AppendLine($"  url: {profile.Plex.Url}");
            sb.AppendLine($"  token: {profile.Plex.Token}");
            sb.AppendLine($"  timeout: {profile.Plex.Timeout}");
            sb.AppendLine($"  db_cache: {profile.Plex.DbCache}");
            sb.AppendLine($"  clean_bundles: {profile.Plex.CleanBundles.ToString().ToLower()}");
            sb.AppendLine($"  empty_trash: {profile.Plex.EmptyTrash.ToString().ToLower()}");
            sb.AppendLine($"  optimize: {profile.Plex.Optimize.ToString().ToLower()}");
            sb.AppendLine($"  verify_ssl: {profile.Plex.VerifySSL.ToString().ToLower()}");
            sb.AppendLine();

            // TMDb configuration
            sb.AppendLine("tmdb:");
            sb.AppendLine($"  apikey: {profile.TMDb.ApiKey}");
            sb.AppendLine($"  cache_expiration: {profile.TMDb.CacheExpiration}");
            sb.AppendLine($"  language: {profile.TMDb.Language}");
            if (!string.IsNullOrEmpty(profile.TMDb.Region))
            {
                sb.AppendLine($"  region: {profile.TMDb.Region}");
            }
            else
            {
                sb.AppendLine("  region:");
            }
            sb.AppendLine();

            // Libraries
            if (profile.SelectedLibraries.Count > 0)
            {
                sb.AppendLine("libraries:");
                
                foreach (var libraryName in profile.SelectedLibraries)
                {
                    sb.AppendLine($"  {libraryName}:");
                    sb.AppendLine("    remove_overlays: false");
                    
                    // Add collection files only if there are selected charts
                    var enabledCharts = profile.SelectedCharts.Where(c => c.Value).ToList();
                    if (enabledCharts.Count > 0)
                    {
                        sb.AppendLine("    collection_files:");
                        foreach (var chart in enabledCharts)
                        {
                            sb.AppendLine($"    - default: {chart.Key}");
                        }
                    }
                    
                    // Add overlay files only if there are enabled overlays
                    var enabledOverlays = profile.OverlaySettings.Where(o => o.Value.IsEnabled).ToList();
                    if (enabledOverlays.Count > 0)
                    {
                        sb.AppendLine("    overlay_files:");
                        foreach (var overlay in enabledOverlays)
                        {
                            // Use only the base overlay type, not the full key with media type and builder level
                            var overlayName = overlay.Value.OverlayType;
                            sb.AppendLine($"      - default: {overlayName}");
                            
                            // Only add template_variables if there are actual customizations
                            bool hasCustomizations = overlay.Value.TemplateVariables.Count > 0;
                            bool hasNonDefaultBuilderLevel = !string.IsNullOrEmpty(overlay.Value.BuilderLevel) && overlay.Value.BuilderLevel != "show";
                            
                            if (hasCustomizations || hasNonDefaultBuilderLevel)
                            {
                                sb.AppendLine("        template_variables:");
                                
                                // Add template variables first
                                foreach (var templateVar in overlay.Value.TemplateVariables)
                                {
                                    sb.AppendLine($"          {templateVar.Key}: {templateVar.Value}");
                                }
                                
                                // Add builder level last if it's non-default
                                if (hasNonDefaultBuilderLevel)
                                {
                                    sb.AppendLine($"          builder_level: {overlay.Value.BuilderLevel}");
                                }
                            }
                        }
                        
                        // Add operations section if needed for rating overlays
                        AddOperationsSection(sb, libraryName, enabledOverlays);
                    }
                    
                    sb.AppendLine();
                }
            }

            // Settings
            sb.AppendLine("settings:");
            sb.AppendLine("  run_order:");
            sb.AppendLine("  - operations");
            sb.AppendLine("  - metadata");
            sb.AppendLine("  - collections");
            sb.AppendLine("  - overlays");
            sb.AppendLine($"  cache: {profile.Settings.Cache.ToString().ToLower()}");
            sb.AppendLine($"  cache_expiration: {profile.Settings.CacheExpiration}");
            sb.AppendLine("  asset_directory:");
            sb.AppendLine("  - config/assets");
            sb.AppendLine("  asset_folders: true");
            sb.AppendLine("  asset_depth: 0");
            sb.AppendLine("  create_asset_folders: false");
            sb.AppendLine("  prioritize_assets: false");
            sb.AppendLine("  dimensional_asset_rename: false");
            sb.AppendLine("  download_url_assets: false");
            sb.AppendLine("  show_missing_season_assets: false");
            sb.AppendLine("  show_missing_episode_assets: false");
            sb.AppendLine("  show_asset_not_needed: true");
            sb.AppendLine($"  sync_mode: {profile.Settings.SyncMode}");
            sb.AppendLine($"  minimum_items: {profile.Settings.MinimumItems}");
            sb.AppendLine("  default_collection_order: release");
            sb.AppendLine($"  delete_below_minimum: {profile.Settings.DeleteBelowMinimum.ToString().ToLower()}");
            sb.AppendLine("  delete_not_scheduled: false");
            sb.AppendLine("  run_again_delay: 2");
            sb.AppendLine("  missing_only_released: false");
            sb.AppendLine("  only_filter_missing: false");
            sb.AppendLine($"  show_unmanaged: {profile.Settings.ShowUnmanaged.ToString().ToLower()}");
            sb.AppendLine("  show_unconfigured: true");
            sb.AppendLine("  show_filtered: false");
            sb.AppendLine("  show_unfiltered: false");
            sb.AppendLine("  show_options: true");
            sb.AppendLine($"  show_missing: {profile.Settings.ShowMissing.ToString().ToLower()}");
            sb.AppendLine("  show_missing_assets: true");
            sb.AppendLine("  save_report: false");
            sb.AppendLine("  tvdb_language: eng");
            sb.AppendLine("  ignore_ids:");
            sb.AppendLine("  ignore_imdb_ids:");
            sb.AppendLine("  item_refresh_delay: 0");
            sb.AppendLine("  playlist_sync_to_users:");
            sb.AppendLine("  playlist_exclude_users:");
            sb.AppendLine("  playlist_report: false");
            sb.AppendLine($"  verify_ssl: {profile.Settings.VerifySSL.ToString().ToLower()}");
            sb.AppendLine("  custom_repo:");
            sb.AppendLine($"  overlay_artwork_filetype: {profile.Settings.OverlayArtworkFiletype}");
            sb.AppendLine($"  overlay_artwork_quality: {profile.Settings.OverlayArtworkQuality}");
            sb.AppendLine();

            // Optional services
            AddOptionalServices(sb, profile);

            return sb.ToString();
        }

        private void AddOptionalServices(StringBuilder sb, KometaProfile profile)
        {
            // Only add services that are enabled
            var servicesToCheck = new[] { "tautulli", "radarr", "sonarr", "gotify", "ntfy", "github", "omdb", "mdblist", "notifiarr", "anidb", "trakt", "mal" };
            
            foreach (var serviceId in servicesToCheck)
            {
                // Check if service is enabled
                if (profile.EnabledServices.ContainsKey(serviceId) && profile.EnabledServices[serviceId])
                {
                    switch (serviceId)
                    {
                        case "tautulli":
                            AddTautulliConfig(sb, profile);
                            break;
                        case "radarr":
                            AddRadarrConfig(sb, profile);
                            break;
                        case "sonarr":
                            AddSonarrConfig(sb, profile);
                            break;
                        case "gotify":
                            AddGotifyConfig(sb, profile);
                            break;
                        case "ntfy":
                            AddNtfyConfig(sb, profile);
                            break;
                        case "github":
                            AddGitHubConfig(sb, profile);
                            break;
                        case "omdb":
                            AddOmdbConfig(sb, profile);
                            break;
                        case "mdblist":
                            AddMdbListConfig(sb, profile);
                            break;
                        case "notifiarr":
                            AddNotifiarrConfig(sb, profile);
                            break;
                        case "anidb":
                            AddAnidbConfig(sb, profile);
                            break;
                        case "trakt":
                            AddTraktConfig(sb, profile);
                            break;
                        case "mal":
                            AddMalConfig(sb, profile);
                            break;
                    }
                }
            }
        }

        private void AddOperationsSection(StringBuilder sb, string libraryName, List<KeyValuePair<string, OverlayConfiguration>> enabledOverlays)
        {
            var operations = new List<string>();
            
            // Check for rating overlays and determine operations needed
            var ratingOverlay = enabledOverlays.FirstOrDefault(o => o.Key == "ratings");
            if (ratingOverlay.Value != null)
            {
                var builderLevel = ratingOverlay.Value.BuilderLevel ?? "show";
                
                // Check what rating types are configured
                bool hasRating1 = ratingOverlay.Value.TemplateVariables.ContainsKey("rating1");
                bool hasRating2 = ratingOverlay.Value.TemplateVariables.ContainsKey("rating2");
                bool hasRating3 = ratingOverlay.Value.TemplateVariables.ContainsKey("rating3");
                
                if (builderLevel == "episode")
                {
                    // Episode-level operations
                    if (hasRating1 && ratingOverlay.Value.TemplateVariables["rating1"].ToString() == "critic")
                        operations.Add("      mass_episode_critic_rating_update: imdb");
                    if (hasRating2 && ratingOverlay.Value.TemplateVariables["rating2"].ToString() == "audience")
                        operations.Add("      mass_episode_audience_rating_update: tmdb");
                }
                else if (builderLevel == "show" || string.IsNullOrEmpty(builderLevel))
                {
                    // Show-level operations (also applies to Movies)
                    if (hasRating1 && ratingOverlay.Value.TemplateVariables["rating1"].ToString() == "user")
                        operations.Add("      mass_user_rating_update: mdb_tomatoes");
                    if (hasRating2 && ratingOverlay.Value.TemplateVariables["rating2"].ToString() == "critic")
                        operations.Add("      mass_critic_rating_update: imdb");
                    if (hasRating3 && ratingOverlay.Value.TemplateVariables["rating3"].ToString() == "audience")
                        operations.Add("      mass_audience_rating_update: tmdb");
                }
                // Season level doesn't need operations
            }
            
            // Add operations section if any operations are needed
            if (operations.Count > 0)
            {
                sb.AppendLine("    operations:");
                foreach (var operation in operations)
                {
                    sb.AppendLine(operation);
                }
            }
        }

        private void AddTautulliConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("tautulli:");
            
            var url = profile.OptionalServices.ContainsKey("tautulli_url") ? profile.OptionalServices["tautulli_url"] : "";
            var apikey = profile.OptionalServices.ContainsKey("tautulli_key") ? profile.OptionalServices["tautulli_key"] : "";
            
            sb.AppendLine($"  url: {url}");
            sb.AppendLine($"  apikey: {apikey}");
            sb.AppendLine();
        }

        private void AddRadarrConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("radarr:");
            
            var url = profile.OptionalServices.ContainsKey("radarr_url") ? profile.OptionalServices["radarr_url"] : "";
            var token = profile.OptionalServices.ContainsKey("radarr_key") ? profile.OptionalServices["radarr_key"] : "";
            
            sb.AppendLine($"  url: {url}");
            sb.AppendLine($"  token: {token}");
            sb.AppendLine("  add_missing: false");
            sb.AppendLine("  add_existing: false");
            sb.AppendLine("  upgrade_existing: false");
            sb.AppendLine("  monitor_existing: false");
            sb.AppendLine("  root_folder_path: \"S:/Movies\"");
            sb.AppendLine("  monitor: true");
            sb.AppendLine("  availability: announced");
            sb.AppendLine("  quality_profile: HD-1080p");
            sb.AppendLine("  tag:");
            sb.AppendLine("  search: false");
            sb.AppendLine("  radarr_path:");
            sb.AppendLine("  plex_path:");
            sb.AppendLine("  ignore_cache: false");
            sb.AppendLine();
        }

        private void AddSonarrConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("sonarr:");
            
            var url = profile.OptionalServices.ContainsKey("sonarr_url") ? profile.OptionalServices["sonarr_url"] : "";
            var token = profile.OptionalServices.ContainsKey("sonarr_key") ? profile.OptionalServices["sonarr_key"] : "";
            
            sb.AppendLine($"  url: {url}");
            sb.AppendLine($"  token: {token}");
            sb.AppendLine("  add_missing: false");
            sb.AppendLine("  add_existing: false");
            sb.AppendLine("  upgrade_existing: false");
            sb.AppendLine("  monitor_existing: false");
            sb.AppendLine("  root_folder_path: \"S:/TV Shows\"");
            sb.AppendLine("  monitor: all");
            sb.AppendLine("  quality_profile: HD-1080p");
            sb.AppendLine("  language_profile: English");
            sb.AppendLine("  series_type: standard");
            sb.AppendLine("  season_folder: true");
            sb.AppendLine("  tag:");
            sb.AppendLine("  search: false");
            sb.AppendLine("  cutoff_search: false");
            sb.AppendLine("  sonarr_path:");
            sb.AppendLine("  plex_path:");
            sb.AppendLine("  ignore_cache: false");
            sb.AppendLine();
        }

        private void AddGotifyConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("gotify:");
            
            var url = profile.OptionalServices.ContainsKey("gotify_url") ? profile.OptionalServices["gotify_url"] : "";
            var token = profile.OptionalServices.ContainsKey("gotify_key") ? profile.OptionalServices["gotify_key"] : "";
            
            sb.AppendLine($"  url: {url}");
            sb.AppendLine($"  token: {token}");
            sb.AppendLine();
        }

        private void AddNtfyConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("ntfy:");
            
            var url = profile.OptionalServices.ContainsKey("ntfy_url") ? profile.OptionalServices["ntfy_url"] : "";
            var token = profile.OptionalServices.ContainsKey("ntfy_key") ? profile.OptionalServices["ntfy_key"] : "";
            
            sb.AppendLine($"  url: {url}");
            sb.AppendLine($"  token: {token}");
            sb.AppendLine("  topic:");
            sb.AppendLine();
        }

        private void AddGitHubConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("github:");
            
            var token = profile.OptionalServices.ContainsKey("github_key") ? profile.OptionalServices["github_key"] : "";
            
            sb.AppendLine($"  token: {token}");
            sb.AppendLine();
        }

        private void AddOmdbConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("omdb:");
            
            var apikey = profile.OptionalServices.ContainsKey("omdb_key") ? profile.OptionalServices["omdb_key"] : "";
            
            sb.AppendLine($"  apikey: {apikey}");
            sb.AppendLine("  cache_expiration: 60");
            sb.AppendLine();
        }

        private void AddMdbListConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("mdblist:");
            
            var apikey = profile.OptionalServices.ContainsKey("mdblist_key") ? profile.OptionalServices["mdblist_key"] : "";
            
            sb.AppendLine($"  apikey: {apikey}");
            sb.AppendLine("  cache_expiration: 60");
            sb.AppendLine();
        }

        private void AddNotifiarrConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("notifiarr:");
            
            var apikey = profile.OptionalServices.ContainsKey("notifiarr_key") ? profile.OptionalServices["notifiarr_key"] : "";
            
            sb.AppendLine($"  apikey: {apikey}");
            sb.AppendLine();
        }

        private void AddAnidbConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("anidb:");
            
            var credentials = profile.OptionalServices.ContainsKey("anidb_key") ? profile.OptionalServices["anidb_key"] : "";
            
            sb.AppendLine($"  username: {credentials}");
            sb.AppendLine("  password:");
            sb.AppendLine("  cache_expiration: 60");
            sb.AppendLine("  client:");
            sb.AppendLine("  language: en");
            sb.AppendLine("  version: 1");
            sb.AppendLine();
        }

        private void AddTraktConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("trakt:");
            
            var credentials = profile.OptionalServices.ContainsKey("trakt_key") ? profile.OptionalServices["trakt_key"] : "";
            
            sb.AppendLine($"  client_id: {credentials}");
            sb.AppendLine("  client_secret:");
            sb.AppendLine("  pin:");
            sb.AppendLine("  authorization:");
            sb.AppendLine("    access_token:");
            sb.AppendLine("    created_at:");
            sb.AppendLine("    expires_in:");
            sb.AppendLine("    refresh_token:");
            sb.AppendLine("    scope: public");
            sb.AppendLine("    token_type:");
            sb.AppendLine();
        }

        private void AddMalConfig(StringBuilder sb, KometaProfile profile)
        {
            sb.AppendLine("mal:");
            
            var credentials = profile.OptionalServices.ContainsKey("mal_key") ? profile.OptionalServices["mal_key"] : "";
            
            sb.AppendLine($"  client_id: {credentials}");
            sb.AppendLine("  client_secret:");
            sb.AppendLine("  cache_expiration: 60");
            sb.AppendLine("  localhost_url:");
            sb.AppendLine("  authorization:");
            sb.AppendLine("    access_token:");
            sb.AppendLine("    expires_in:");
            sb.AppendLine("    refresh_token:");
            sb.AppendLine("    token_type:");
            sb.AppendLine();
        }

        public void SaveConfigToFile(string yamlContent, string filePath)
        {
            File.WriteAllText(filePath, yamlContent, Encoding.UTF8);
        }

        private string ExtractIpFromUrl(string url)
        {
            try
            {
                var uri = new Uri(url);
                return uri.Host;
            }
            catch
            {
                return "192.168.1.12"; // Default fallback
            }
        }
    }
}